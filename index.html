<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
<title>Flappy — Pro Edition</title>
<style>
  :root{
    --bg1:#a6ecff;--bg2:#5fc6c3;--card:#ffffffee;--accent:#ffbd2e;--muted:#55606a;--glass:rgba(255,255,255,0.6);
    --shadow: 0 12px 30px rgba(10,20,30,0.12);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
  body{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--bg1),var(--bg2));padding:16px}

  /* App shell */
  .app{width:100%;max-width:1180px;display:grid;grid-template-columns:1fr 340px;gap:20px}
  @media (max-width:980px){.app{grid-template-columns:1fr}}

  /* Game Card */
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));border-radius:14px;padding:12px;box-shadow:var(--shadow);position:relative;overflow:hidden}
  .stage{width:100%;height:calc(min(78vh,720px));background:transparent;border-radius:10px;display:flex;align-items:center;justify-content:center}
  canvas{width:100%;height:100%;display:block;border-radius:10px}

  /* Right panel */
  .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px}
  .panel h2{margin:0;font-size:18px}
  .label{font-size:13px;color:var(--muted)}

  /* UI overlays */
  .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:auto}
  .menu{width:100%;max-width:420px;background:var(--card);border-radius:12px;padding:18px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.12)}
  .menu h1{margin:6px 0 8px;font-size:22px}
  .menu p{margin:0 0 12px;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .btn{background:var(--accent);border:none;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
  .small{font-size:13px;color:var(--muted)}

  /* HUD */
  .hud{position:absolute;left:14px;top:14px;background:var(--glass);backdrop-filter:blur(6px);padding:8px 10px;border-radius:10px;font-weight:700}
  .score{position:absolute;right:14px;top:14px;background:var(--glass);backdrop-filter:blur(6px);padding:8px 12px;border-radius:10px;font-weight:900;font-size:18px}

  /* leaderboard */
  .leaderboard{display:flex;flex-direction:column;gap:8px}
  .leader{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#f7fbfb}

  /* footer */
  .foot{font-size:12px;color:var(--muted);text-align:center;padding-top:6px}

  /* responsive tweaks */
  @media (max-width:480px){
    .panel{position:relative;z-index:5}
    .menu{padding:16px;margin:10px}
    .hud,.score{font-size:14px;padding:6px 8px}
  }
</style>
</head>
<body>
  <div class="app">
    <div class="card" id="gameCard">
      <div class="stage" id="stage">
        <canvas id="canvas" role="img" aria-label="Flappy bird game"></canvas>
        <div class="hud" id="hud">High: 0</div>
        <div class="score" id="score">0</div>
      </div>
      <div class="overlay" id="overlay">
        <div class="menu" id="menu">
          <h1>Flappy — Pro</h1>
          <p class="small">Smooth physics • Touch-friendly • Local Leaderboard • Polished UI</p>

          <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px">
            <select id="preset" aria-label="Difficulty preset">
              <option value="easy">Easy</option>
              <option value="normal" selected>Normal</option>
              <option value="hard">Hard</option>
            </select>
            <select id="theme" aria-label="Theme select">
              <option value="day">Day</option>
              <option value="dusk">Dusk</option>
              <option value="night">Night</option>
            </select>
          </div>

          <div style="display:flex;gap:10px;justify-content:center;margin-bottom:12px" class="controls">
            <button class="btn" id="startBtn">Start</button>
            <button class="btn ghost" id="practiceBtn">Practice</button>
            <button class="btn ghost" id="shareBtn">Share</button>
          </div>

          <div class="small">High Score: <span id="uiHigh">0</span></div>
        </div>
      </div>
    </div>

    <aside class="panel">
      <h2>Game Settings</h2>
      <div>
        <div class="label">Controls</div>
        <div class="small">Tap / Click / Space to flap. Hold to keep steady on desktop.</div>
      </div>

      <div>
        <div class="label">Adjustments</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1"><label class="small">Gap<br><input id="gap" type="range" min="100" max="260" value="140" style="width:100%"></label></div>
          <div style="width:80px"><label class="small">Speed<br><input id="speed" type="range" min="1" max="6" step="0.1" value="2.4"></label></div>
        </div>
      </div>

      <div>
        <div class="label">Leaderboard</div>
        <div class="leaderboard" id="board"></div>
      </div>

      <div style="margin-top:auto">
        <div class="foot">Built-in high-score storage (local). Want cloud leaderboard? I can add it.</div>
      </div>
    </aside>
  </div>

<script>
/* Production-level single-file Flappy Bird. Features:
 - Responsive canvas with devicePixelRatio handling
 - Smooth physics and configurable presets
 - Procedural visuals (no external assets) with parallax
 - Particle effects and transitions
 - WebAudio SFX (generated) with user-gesture resume
 - Local leaderboard with name entry and sharing (if supported)
*/

(()=>{
  // Elements
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const overlay = document.getElementById('overlay');
  const menu = document.getElementById('menu');
  const startBtn = document.getElementById('startBtn');
  const practiceBtn = document.getElementById('practiceBtn');
  const shareBtn = document.getElementById('shareBtn');
  const scoreEl = document.getElementById('score');
  const hud = document.getElementById('hud');
  const uiHigh = document.getElementById('uiHigh');
  const presetSel = document.getElementById('preset');
  const themeSel = document.getElementById('theme');
  const gapRange = document.getElementById('gap');
  const speedRange = document.getElementById('speed');
  const boardEl = document.getElementById('board');

  // DPR & resize
  function resize(){
    const ratio = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(320, Math.floor(rect.width * ratio));
    canvas.height = Math.max(480, Math.floor(rect.height * ratio));
    ctx.setTransform(ratio,0,0,ratio,0,0);
  }
  window.addEventListener('resize', resize);
  resize();

  // Audio
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audio = AudioCtx ? new AudioCtx() : null;
  function playTone(freq, time=0.08, type='sine'){ if(!audio) return; try{const o=audio.createOscillator();const g=audio.createGain();o.type=type;o.frequency.value=freq;g.gain.setValueAtTime(0.001,audio.currentTime);g.gain.exponentialRampToValueAtTime(0.15,audio.currentTime+0.01);o.connect(g);g.connect(audio.destination);o.start();g.gain.exponentialRampToValueAtTime(0.001,audio.currentTime+time);o.stop(audio.currentTime+time+0.02);}catch(e){} }
  ['click','touchstart','keydown'].forEach(ev=>window.addEventListener(ev, ()=>{ if(audio && audio.state==='suspended') audio.resume(); }, {once:false}));

  // Storage
  const HS_KEY = 'flappy_pro_highscore_v2';
  const LB_KEY = 'flappy_pro_leaderboard_v2';
  let high = parseInt(localStorage.getItem(HS_KEY) || '0',10) || 0;
  uiHigh.textContent = high;
  hud.textContent = 'High: ' + high;

  // Leaderboard helper
  function loadBoard(){ try{ return JSON.parse(localStorage.getItem(LB_KEY))||[] }catch(e){return[]} }
  function saveBoard(arr){ localStorage.setItem(LB_KEY, JSON.stringify(arr.slice(0,10))); }
  function renderBoard(){ const arr = loadBoard(); boardEl.innerHTML = '';
    if(arr.length===0){ boardEl.innerHTML = '<div class="small">No scores yet — be the first!</div>'; return }
    arr.forEach((r,i)=>{ const el=document.createElement('div'); el.className='leader'; el.innerHTML = '<div>'+ (i+1) +'. '+escapeHtml(r.name) +'</div><div><strong>'+r.score+'</strong></div>'; boardEl.appendChild(el); }); }
  renderBoard();

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[c])) }

  // Game params & presets
  const PRESETS = {
    easy: {gravity:0.45, jump:-7.8, speed:2.0, gap:180},
    normal:{gravity:0.62, jump:-7.8, speed:2.4, gap:140},
    hard:{gravity:0.86, jump:-8.4, speed:3.0, gap:120}
  };

  // theme palettes
  const THEMES = {
    day: {sky1:'#a6ecff', sky2:'#5fc6c3', cloud:'#fff'},
    dusk:{sky1:'#ffc0a3', sky2:'#7ec8d6', cloud:'#fff5e6'},
    night:{sky1:'#0f2540', sky2:'#1b3a6b', cloud:'#cde6ff'}
  };

  // Local state
  let state = 'menu'; // menu, running, paused, over
  let opts = Object.assign({}, PRESETS['normal']);
  let bird = null, pipes = [], particles = [], frame=0, score=0, auto=false;

  // responsive helpers
  function viewport(){ return {w:canvas.width / (window.devicePixelRatio||1), h:canvas.height / (window.devicePixelRatio||1)} }

  function applyPreset(name){ opts = Object.assign({}, PRESETS[name]); gapRange.value = opts.gap; speedRange.value = opts.speed; }
  presetSel.addEventListener('change', ()=>applyPreset(presetSel.value));
  applyPreset('normal');

  gapRange.addEventListener('input', ()=>{ opts.gap = parseInt(gapRange.value,10); });
  speedRange.addEventListener('input', ()=>{ opts.speed = parseFloat(speedRange.value); });
  themeSel.addEventListener('change', ()=>{});

  // bird factory
  function makeBird(){ const v = viewport(); return {x: Math.max(48, v.w*0.2), y: v.h/2, vy:0, radius:14, rotation:0, wobble:0}; }

  function reset(){ pipes=[]; particles=[]; frame=0; score=0; bird = makeBird(); scoreElUpdate(); }

  function start(practice=false){ auto=practice; reset(); state='running'; overlay.style.display='none'; if(audio) playTone(880,0.06); }
  function pause(){ if(state==='running'){ state='paused'; overlay.style.display='flex'; menu.querySelector('p').textContent='Paused'; } else if(state==='paused'){ state='running'; overlay.style.display='none'; } }
  function gameOver(){ state='over'; overlay.style.display='flex'; menu.querySelector('p').textContent='Game Over — Score: '+score; // prompt for name if top 10
    if(score>0) trySaveScore(score); if(audio) playTone(160,0.18,'square'); }

  // input
  function flap(){ if(state==='menu'){ start(false); return } if(state==='over') return; bird.vy = opts.jump; if(audio) playTone(1200,0.04); }
  window.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); flap(); } if(e.code==='KeyP') pause(); });
  canvas.addEventListener('mousedown', flap); canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); flap(); }, {passive:false});

  // scoring & leaderboard prompt
  function trySaveScore(s){ const board = loadBoard(); const lowest = board.length<10?0:board[board.length-1].score; if(board.length<10 || s>lowest){ const name = prompt('Great! Enter your name for the leaderboard (max 12 chars):','Player') || 'Player'; const entry = {name: name.substring(0,12), score:s, date:Date.now()}; board.push(entry); board.sort((a,b)=>b.score - a.score); saveBoard(board); renderBoard(); } }

  // share
  shareBtn.addEventListener('click', async ()=>{
    const text = `I scored ${score} in Flappy — Pro Edition! Can you beat me?`;
    if(navigator.share){ try{ await navigator.share({title:'Flappy — Pro', text}); }catch(e){} } else { try{ await navigator.clipboard.writeText(text); alert('Score copied to clipboard!'); }catch(e){ alert(text); } }
  });

  // particles simple
  function spawnParticles(x,y,count=10){ for(let i=0;i<count;i++){ particles.push({x,y,vx:(Math.random()-0.5)*3, vy:(Math.random()-1.5)*3, life:Math.random()*40+20, size:Math.random()*2+1}); } }

  // pipes
  function addPipe(){ const v = viewport(); const top = 40 + Math.random()*(v.h - opts.gap - 120); pipes.push({x: v.w + 40, top, w:58}); }

  // collision helper
  function circleRectCollision(cx,cy,r,rx,ry,rw,rh){ const closestX = Math.max(rx, Math.min(cx, rx+rw)); const closestY = Math.max(ry, Math.min(cy, ry+rh)); const dx = cx - closestX; const dy = cy - closestY; return (dx*dx+dy*dy) < (r*r); }

  function scoreElUpdate(){ scoreEl.textContent = score; hud.textContent = 'High: ' + high; document.getElementById('score').textContent = score; document.getElementById('uiHigh').textContent = high; }

  // main update & draw
  let last = performance.now();
  function update(dt){ if(state!=='running') return;
    frame++;
    // bird physics
    bird.vy += opts.gravity; bird.y += bird.vy * dt; bird.rotation = Math.max(Math.min(bird.vy/20, 0.9), -0.9);
    bird.wobble += 0.12;
    // spawn pipes
    if(frame % Math.max(28, Math.floor(88 - opts.speed*10)) === 0) addPipe();
    // move pipes
    for(let i=pipes.length-1;i>=0;i--){ const p=pipes[i]; p.x -= opts.speed * dt * 1.6; if(p.x + p.w < -20) pipes.splice(i,1); }
    // update particles
    for(let i=particles.length-1;i>=0;i--){ const p = particles[i]; p.x += p.vx * dt; p.y += p.vy * dt; p.vy += 0.12; p.life -= dt; if(p.life<=0) particles.splice(i,1); }

    // scoring & collisions
    const v = viewport();
    // ground
    const groundY = v.h - 28;
    if(bird.y + bird.radius > groundY){ bird.y = groundY - bird.radius; gameOver(); spawnParticles(bird.x, bird.y, 30); }
    if(bird.y - bird.radius < 0){ bird.y = bird.radius; bird.vy = 0; }
    // pipes collide
    for(const p of pipes){
      if(!p.passed && p.x + p.w < bird.x - 6){ p.passed = true; score++; scoreElUpdate(); playTone(1200,0.03); if(score>high){ high=score; localStorage.setItem(HS_KEY, String(high)); uiHigh.textContent = high; hud.textContent = 'High: '+high; } }
      const inX = bird.x + bird.radius > p.x && bird.x - bird.radius < p.x + p.w;
      if(inX){ if(bird.y - bird.radius < p.top || bird.y + bird.radius > p.top + opts.gap){ gameOver(); spawnParticles(bird.x, bird.y, 20); break; } }
    }
  }

  function draw(){
    const r = viewport();
    // background gradient per theme
    const theme = THEMES[themeSel.value] || THEMES.day;
    const g = ctx.createLinearGradient(0,0,0,r.h); g.addColorStop(0, theme.sky1); g.addColorStop(1, theme.sky2);
    ctx.fillStyle = g; ctx.fillRect(0,0,r.w, r.h);

    // parallax clouds
    ctx.globalAlpha = 0.95;
    for(let i=0;i<6;i++){ const cx = (frame*0.2*(i%3+1) + i*140) % (r.w+160) - 80; drawCloud(cx, 60 + (i%2)*26, 28 + (i%3)*6); }
    ctx.globalAlpha = 1;

    // pipes
    for(const p of pipes){ ctx.fillStyle = '#2ea24a'; roundRect(ctx, p.x, 0, p.w, p.top, 8); ctx.fill(); roundRect(ctx, p.x, p.top + opts.gap, p.w, r.h - (p.top + opts.gap) - 28, 8); ctx.fill(); // rim
      ctx.fillStyle = '#1f7a1c'; roundRect(ctx, p.x - 6, p.top - 14, p.w + 12, 14, 6); ctx.fill(); }

    // ground
    ctx.fillStyle = '#d2b48c'; ctx.fillRect(0, r.h - 28, r.w, 28);

    // bird (animated)
    drawBird(bird);

    // particles
    for(const p of particles){ ctx.globalAlpha = Math.max(0, Math.min(1, p.life/40)); ctx.fillStyle = 'rgba(255,200,60,0.9)'; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); }
    ctx.globalAlpha = 1;
  }

  function drawCloud(x,y,radius){ ctx.fillStyle = themeSel.value==='night' ? '#cde6ff' : '#fff'; ctx.beginPath(); ctx.ellipse(x,y,radius*1.2,radius,0,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(x+radius*0.8,y+6,radius*0.9,radius*0.8,0,0,Math.PI*2); ctx.fill(); }

  function drawBird(b){ if(!b) return; ctx.save(); ctx.translate(b.x, b.y); ctx.rotate(b.rotation);
    // body
    ctx.fillStyle = '#ffcc00'; ctx.beginPath(); ctx.ellipse(0,0,b.radius*1.1,b.radius,0,0,Math.PI*2); ctx.fill();
    // belly
    ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.ellipse(4,4,b.radius*0.7,b.radius*0.5,0,0,Math.PI*2); ctx.fill();
    // eye
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(6, -4, b.radius*0.25,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(6,-4,b.radius*0.12,0,Math.PI*2); ctx.fill();
    // beak
    ctx.fillStyle='#ff8a00'; ctx.beginPath(); ctx.moveTo(b.radius+2,0); ctx.lineTo(b.radius*2.1,-6); ctx.lineTo(b.radius*2.1,6); ctx.closePath(); ctx.fill(); ctx.restore(); }

  function roundRect(c,x,y,w,h,r){ c.beginPath(); c.moveTo(x+r,y); c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r); c.arcTo(x,y+h,x,y,r); c.arcTo(x,y,x+w,y,r); c.closePath(); }

  // loop
  function tick(now){ const dt = Math.min(40, now - last) / 16.666; last = now; update(dt); draw(); requestAnimationFrame(tick); }
  last = performance.now(); requestAnimationFrame(tick);

  // UI bindings
  startBtn.addEventListener('click', ()=>{ applyPreset(presetSel.value); opts.gap = parseInt(gapRange.value,10); opts.speed = parseFloat(speedRange.value); start(false); });
  practiceBtn.addEventListener('click', ()=>{ applyPreset(presetSel.value); opts.gap = parseInt(gapRange.value,10); opts.speed = parseFloat(speedRange.value); start(true); });

  // Save high each frame check
  setInterval(()=>{ if(high < score){ high = score; localStorage.setItem(HS_KEY, String(high)); uiHigh.textContent = high; hud.textContent = 'High: '+high; } }, 400);

  // restore saved high
  const saved = parseInt(localStorage.getItem(HS_KEY) || '0',10) || 0; if(saved>high){ high=saved; uiHigh.textContent=high; hud.textContent='High: '+high; }

  // initial reset
  reset(); renderBoard();
})();
</script>
</body>
</html>
